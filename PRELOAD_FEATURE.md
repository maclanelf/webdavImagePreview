# 预加载功能说明

## 🚀 功能概述

为了解决使用clouddrive2挂载115网盘时的延迟问题，我们实现了智能预加载功能。该功能可以提前加载20张图片或视频（视频小于100MB），让预览体验更加丝滑。

## ✨ 主要特性

- **智能预加载**: 自动预加载20个媒体文件到内存缓存
- **视频限制**: 只预加载小于100MB的视频文件
- **缓存管理**: 自动管理缓存大小，避免内存溢出
- **智能预测**: 根据当前查看的文件智能预加载相关文件
- **缓存过期**: 5分钟自动清理过期缓存
- **实时状态**: 显示缓存状态和预加载进度

## 🔧 技术实现

### 预加载管理器 (`lib/preloadManager.ts`)

```typescript
// 创建预加载管理器实例
import preloadManager from '@/lib/preloadManager'

// 预加载文件
const result = await preloadManager.preloadFiles(config, files, 20)

// 获取预加载的文件
const blob = preloadManager.getPreloadedFile(filepath)

// 智能预加载
await preloadManager.smartPreload(config, allFiles, currentFile, 10)
```

### API接口 (`app/api/webdav/preload/route.ts`)

- `POST /api/webdav/preload` - 开始预加载
- `GET /api/webdav/preload?filepath=xxx` - 获取预加载的文件
- `PUT /api/webdav/preload` - 缓存管理操作

## 🎯 使用方法

### 1. 启用预加载

在侧边栏的"预加载设置"中：
- 点击"启用预加载"按钮
- 系统会自动开始预加载20个文件

### 2. 查看缓存状态

- 缓存状态显示：`已缓存文件数 / 最大缓存数`
- 预加载进度显示：`当前进度 / 总进度`

### 3. 清理缓存

- 点击"清理缓存"按钮
- 手动清理所有预加载的缓存

## 📊 性能优化

### 缓存策略

- **最大缓存**: 20个文件
- **过期时间**: 5分钟
- **清理策略**: LRU（最近最少使用）

### 预加载策略

1. **初始预加载**: 扫描完成后自动预加载20个随机文件
2. **智能预加载**: 查看文件时预加载同目录的其他文件
3. **视频限制**: 只预加载小于100MB的视频文件

### 内存管理

- 使用Blob对象存储文件内容
- 自动清理过期缓存
- 超出限制时删除最旧的缓存

## 🔍 调试信息

### 控制台日志

```javascript
// 预加载完成
console.log('预加载完成: 文件名')

// 使用预加载文件
console.log('使用预加载文件: 文件名')

// 预加载失败
console.error('预加载失败 文件名: 错误信息')
```

### 状态监控

```javascript
// 获取缓存状态
const status = preloadManager.getCacheStatus()
console.log('缓存状态:', status)
```

## 🚨 注意事项

1. **内存使用**: 预加载会占用更多内存，建议在内存充足的环境使用
2. **网络带宽**: 预加载会消耗网络带宽，建议在网络条件良好时使用
3. **视频大小**: 只预加载小于100MB的视频文件
4. **缓存过期**: 缓存会在5分钟后自动过期

## 🧪 测试

运行测试脚本：

```bash
node test-preload.js
```

测试内容包括：
- 预加载API测试
- 缓存状态API测试
- 清理缓存API测试

## 📈 性能提升

使用预加载功能后：
- **图片加载**: 从网络延迟降低到几乎即时
- **小视频加载**: 从网络延迟降低到几乎即时
- **用户体验**: 预览更加流畅，无等待感

## 🔄 兼容性

- 完全兼容现有的随机预览功能
- 支持图组模式和随机模式
- 支持所有媒体类型筛选
- 不影响评分和分类功能
